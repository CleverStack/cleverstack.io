<h3 class="page-header" id="backend-modules">Modules</h3>
<p class="lead">These are the most important part of your application, where all your functionality, dependencies and testing are defined.</p>

<!-- Modules structure
================================================== -->
<h4 class="page-header" id="backend-modules-structure">Structure</h4>
{% highlight bash %}
example-module/
├── bin/                  # module scripts & binaries
├── classes/              # module classes
├── config/               # module specific configs and setting overrides
├── controllers/          # module controllers
├── exceptions/           # module custom exceptions
├── models/               # module models
├── schema/               # your schema is stored in here
│   └── seedData.json/    # seed data is used to populate your database tables
├── services/             # module services
├── tests/
│   ├── e2e/              # module end to end tests
│   └── unit/             # module unit tests
├── utils/                # module utils
├── Gruntfile.js          # module grunt tasks
├── module.js             # main module class
├── package.json          # module npm dependencies
└── routes.js             # module routes
{% endhighlight %}<br>
<div style="padding-left: 30px;">
  <h4>Important files and folders</h5>

  <h5 id="backend-modules-config-default">config/</h5>
  <ul>
    <li>Like the applications config folder this module config folder allows you to provide configuration on a per module basis.</li>
    <li><a href="#backend-modules-config-default">&lt;module&gt;/config/default.json</a></li>
    <li><a href="#backend-modules-config-global">&lt;module&gt;/config/global.json</a></li><br>
    <li><span class="label label-danger">Important</span> Every module's json config files must contain (if they exist on disk) an object that has all configuration objects nested in an object under one key which needs to be named the same as your &lt;module&gt;.</li>
{% highlight json %}
{
"moduleName": {
"config": "here",
"another": "as well"
}
}
{% endhighlight %}
  </ul>

  <h5>tests/</h5>
  <ul>
      <li>Two folders for testing, e2e/ and unit/</li>
      <li>This allows each module to define it's own tests for the functionality (code) that is provided within each module.</li>
  </ul>

  <h5>package.json</h5>
  <ul>
      <li>Defines the modules basic information including name, version and scripts.</li>
      <li>Defines the modules NPM dependencies.</li>
  </ul>

  <h5>Gruntfile.js</h5>
  <ul>
      <li>A specially formatted Gruntfile which can be used to modify the applications gruntConfig and register grunt tasks.</li>
  </ul>

  <h5>module.js</h5>
  <ul>
      <li>Must export a Module Class which will be imported by the moduleLoader.</li>
  </ul>
  <div class="bs-callout bs-callout-info">
    <h4>Lifecycle Hooks</h4>
    <p>Modules have lifecycle <a href="#backend-modules-hooks">hooks</a> for every situation, like loading, routing, shutdown etc.</p>
  </div>
  <div class="bs-callout bs-callout-danger">
    <h4>File name may change per module</h4>
    <p>This presumes you have { "main": "module.js" } in your modules <a href="https://github.com/CleverStack/backend-example-module/blob/master/package.json#L22">package.json</a>, otherwise it is named what you want OR if not set at all this file will be called index.js. (As per standard NPM Modules)</p>
  </div>
  <p>Here is an example of a module.js file</p>
{% highlight javascript %}
// Example module.js
var Module = require( 'classes' ).Module;

module.exports = Module.extend({
preSetup: function() {
  console.log( 'Hello, this module is about to be setup by the moduleLoader' )
}
});
{% endhighlight %}

  <h5>routes.js</h5>
  <ul>
      <li>This is where you define what routes your module will handle.</li>
  </ul>
</div><br>

  <!-- Modules configuration
  ================================================== -->
  <h4 class="page-header" id="backend-modules-configuration">Configuration</h4>
  <p>You can easily define the modules configuration with these files</p>
  <h5 id="backend-modules-config-default">config/default.json</h5>
  <ul>
    <li><span class="label label-info">Note</span> This file is used mainly to define the basic structure of configuration for each module, primarily used to "prevent cannot access variable of undefined" errors where code relies on the structure of the configuration object.</li>
    <li><strong>This file is not required.</strong></li>
  </ul>

  <h5 id="backend-modules-config-global">config/global.json</h5>
  <ul>
    <li>This file is used to define the GLOBAL settings for this module</li><br>
    <li><span class="label label-info">Note</span> this configuration file is used to provide the default GLOBAL config for each module.</li>
    <li><strong>This file is not required.</strong></li>
  </ul><br>

  <p><span class="label label-danger">Important</span> Each of these JSON config files must contain (if they exist on disk) an object that has all configuration objects nested in an object under one key which needs to be named the same as your &lt;module&gt;.</p>
{% highlight json %}
{
"module-name": {
"config": "here",
"another": "as well"
}
}
{% endhighlight %}


<!-- Module hooks
================================================== -->
<h4 class="page-header" id="backend-modules-hooks">Hooks</h4>
<p>Your 'module.js' file has some lifecycle hooks that you can use to perform operations at certain times during the applications lifecycle, the hooks are fired in the order they are listed here on each module.</p><br>

<p>Example of using a hook:<p>
{% highlight javascript %}
var Module = require( 'classes' ).Module;

module.exports = Module.extend({
preInit: function( ) {
  console.log( 'preInit hook, init is about to be called' );
}
});
{% endhighlight %}<br>
<div class="bs-callout bs-callout-danger">
  <h4>Hook firing order</h4>
  <p>Modules hooks are applied to each module in the order you have them listed in your package.json <a href="https://www.npmjs.org/doc/json.html">bundledDependencies[]</a>.</p>
</div>

<h5 id="backend-modules-hooks-presetup">preSetup</h5>
<ul>
  <li>This hook is fired inside the main constructor function setup() how it is called before any setup has actually taken place.</li>
</ul>

<h5 id="backend-modules-hooks-preinit">preInit</h5>
<ul>
  <li>This hook is fired just before init() is called, while init() is not a hook but a method you can override without having to call this._super().</li>
  <li><span class="label label-danger">Important</span> This is the last place to hook into until after init.</li>
</ul>

<h5 id="backend-modules-hooks-init">init</h5>
<ul>
  <li>While this is not a hook, you are able to implement this function which forms the final step in the constructor, meaning it can take advantage of the Optimizing Compiler.</li>
</ul>

<h5 id="backend-modules-hooks-configure-app">configureApp</h5>
<ul>
  <li>This hook allows you to modify the express app from within a module, without the need to make those changes in the index.js file located at backend/index.js</li><br>
  <li><span class="label label-danger">Important</span> you must emit "appConfigured", until you do the moduleLoader will wait.</li>
  <li><span class="label label-danger">Important</span> this function is injected with app &amp; express as arguments in the constructors setup() function.</li>
</ul>
{% highlight javascript %}
var Module = require( 'classes' ).Module;

module.exports = Module.extend({
configureApp: function ( app, express ) {
  app.use( express.cookieParser() );
  this.emit( 'appConfigured' );
}
});
{% endhighlight %}

<h5 id="backend-modules-hooks-preresources">preResources</h5>
<ul>
  <li>This hook is fired just before the main setup() constructor function calls loadResources().</li>
  <li><span class="label label-danger">Important</span> you must emit "resourcesReady", until you do the moduleLoader will wait.</li>
</ul>

<h5 id="backend-modules-hooks-modulesloaded">modulesLoaded</h5>
<ul>
  <li>This hook is fired after all modules are loaded (for each module).</li>
  <li><span class="label label-danger">Important</span> you must emit "ready", until you do the moduleLoader will wait.</li>
  </ul>

  <h5 id="backend-modules-hooks-preroute">preRoute</h5>
  <ul>
    <li>This hook is fired just before your routes are attached.</li>
  </ul>

  <h5 id="backend-modules-hooks-preshutdown">preShutdown</h5>
  <ul>
    <li>This hook is fired just before the application shuts down, allowing you to perform any cleanup related tasks.</li>
  </ul>